swagger: "2.0"
info:
  title: MediSupply API
  version: "1.0.0"

basePath: /
schemes: ["https"]
consumes: ["application/json"]
produces: ["application/json"]

parameters:
  CountryHeader:
    name: X-Country
    in: header
    required: true
    type: string

  ProductoIdParam:
    name: producto_id
    in: path
    required: true
    type: string
    format: uuid

definitions:
  ErrorResponse:
    type: object
    properties:
      message: { type: string }
      code: { type: integer, format: int32 }

  PedidoCreate:
    type: object
    required: [cliente_id, items]
    properties:
      cliente_id: { type: string }
      items:
        type: array
        items:
          type: object
          required: [sku, qty]
          properties:
            sku: { type: string }
            qty: { type: integer, format: int32 }

  Pedido:
    type: object
    properties:
      id: { type: string }
      status: { type: string }
      created_at: { type: string, format: date-time }

  MeResponse:
    type: object
    properties:
      sub: { type: string }
      email: { type: string }
      name: { type: string }
      roles:
        type: array
        items: { type: string }

paths:
  /v1/pedidos:
    get:
      operationId: Pedidos_List
      x-google-backend:
        address: "${MS_PEDIDOS_URL}"
        path_translation: "APPEND_PATH_TO_ADDRESS"
        disable_auth: true
      summary: Listar pedidos (opcional por ID)
      parameters:
        - $ref: "#/parameters/CountryHeader"
        - name: id
          in: query
          type: string
          required: false
      responses:
        200: { description: OK }
        401: { description: Unauthorized, schema: { $ref: "#/definitions/ErrorResponse" } }
        403: { description: Forbidden,   schema: { $ref: "#/definitions/ErrorResponse" } }
        500: { description: Server error, schema: { $ref: "#/definitions/ErrorResponse" } }

    post:
      operationId: Pedidos_Create
      x-google-backend:
        address: "${MS_PEDIDOS_URL}"
        path_translation: "APPEND_PATH_TO_ADDRESS"
        disable_auth: true
      summary: Crear un pedido
      parameters:
        - $ref: "#/parameters/CountryHeader"
        - name: body
          in: body
          required: true
          schema: { $ref: "#/definitions/PedidoCreate" }
      responses:
        201: { description: Creado, schema: { $ref: "#/definitions/Pedido" } }
        400: { description: Bad request, schema: { $ref: "#/definitions/ErrorResponse" } }
        401: { description: Unauthorized, schema: { $ref: "#/definitions/ErrorResponse" } }
        500: { description: Server error, schema: { $ref: "#/definitions/ErrorResponse" } }

    options:
      operationId: CorsPreflightPedidos
      summary: CORS preflight
      security: []
      x-google-backend:
        address: "${MS_PEDIDOS_URL}"
        path_translation: "APPEND_PATH_TO_ADDRESS"
        disable_auth: true
      responses:
        204: { description: No Content }

  /v1/inventario/producto:
    post:
      operationId: producto_crear
      x-google-backend:
        address: "${MS_INVENTARIO_URL}"
        path_translation: "APPEND_PATH_TO_ADDRESS"
        disable_auth: true
      summary: Crear producto
      parameters:
        - $ref: "#/parameters/CountryHeader"
        - name: body
          in: body
          required: true
          schema:
            type: object
            required: [sku, nombre]
            properties:
              sku: { type: string }
              nombre: { type: string }
              categoria: { type: string }
              controlado: { type: boolean }
              temp_min: { type: number, format: float }
              temp_max: { type: number, format: float }
      responses:
        200: { description: OK }

    options:
      operationId: CorsPreflightInventarioProducto
      summary: CORS preflight
      security: []
      x-google-backend:
        address: "${MS_INVENTARIO_URL}"
        path_translation: "APPEND_PATH_TO_ADDRESS"
        disable_auth: true
      responses:
        204: { description: No Content }

  /v1/inventario/producto/{producto_id}/certificacion:
    post:
      operationId: producto_certificacion
      x-google-backend:
        address: "${MS_INVENTARIO_URL}"
        path_translation: "APPEND_PATH_TO_ADDRESS"
        disable_auth: true
      summary: Agregar certificación a producto
      parameters:
        - $ref: "#/parameters/CountryHeader"
        - $ref: "#/parameters/ProductoIdParam"
        - name: body
          in: body
          required: true
          schema:
            type: object
            required: [autoridad, tipo, vigencia]
            properties:
              autoridad: { type: string }
              tipo: { type: string }
              vigencia: { type: string, format: date-time }
      responses:
        200: { description: OK }

    options:
      operationId: CorsPreflightInventarioProductoCertificacion
      summary: CORS preflight
      security: []
      parameters:
        - $ref: "#/parameters/ProductoIdParam"
      x-google-backend:
        address: "${MS_INVENTARIO_URL}"
        path_translation: "APPEND_PATH_TO_ADDRESS"
        disable_auth: true
      responses:
        204: { description: No Content }

  /v1/inventario/bodega:
    post:
      operationId: bodega_crear
      x-google-backend:
        address: "${MS_INVENTARIO_URL}"
        path_translation: "APPEND_PATH_TO_ADDRESS"
        disable_auth: true
      summary: Crear bodega
      parameters:
        - $ref: "#/parameters/CountryHeader"
        - name: body
          in: body
          required: true
          schema:
            type: object
            required: [direccion, ciudad, pais]
            properties:
              direccion: { type: string }
              ciudad: { type: string }
              pais: { type: string }
      responses:
        200: { description: OK }

    options:
      operationId: CorsPreflightInventarioBodega
      summary: CORS preflight
      security: []
      x-google-backend:
        address: "${MS_INVENTARIO_URL}"
        path_translation: "APPEND_PATH_TO_ADDRESS"
        disable_auth: true
      responses:
        204: { description: No Content }

  /v1/inventario/ubicacion:
    post:
      operationId: ubicacion_crear
      x-google-backend:
        address: "${MS_INVENTARIO_URL}"
        path_translation: "APPEND_PATH_TO_ADDRESS"
        disable_auth: true
      summary: Crear ubicación
      parameters:
        - $ref: "#/parameters/CountryHeader"
        - name: body
          in: body
          required: true
          schema:
            type: object
            required: [bodega_id, pasillo, estante, posicion]
            properties:
              bodega_id: { type: string, format: uuid }
              pasillo: { type: string }
              estante: { type: string }
              posicion: { type: string }
      responses:
        200: { description: OK }

    options:
      operationId: CorsPreflightInventarioUbicacion
      summary: CORS preflight
      security: []
      x-google-backend:
        address: "${MS_INVENTARIO_URL}"
        path_translation: "APPEND_PATH_TO_ADDRESS"
        disable_auth: true
      responses:
        204: { description: No Content }

  /v1/inventario/lote:
    post:
      operationId: lote_crear
      x-google-backend:
        address: "${MS_INVENTARIO_URL}"
        path_translation: "APPEND_PATH_TO_ADDRESS"
        disable_auth: true
      summary: Crear lote
      parameters:
        - $ref: "#/parameters/CountryHeader"
        - name: body
          in: body
          required: true
          schema:
            type: object
            required: [producto_id, codigo]
            properties:
              producto_id: { type: string, format: uuid }
              codigo: { type: string }
              vencimiento: { type: string, format: date-time }
      responses:
        200: { description: OK }

    options:
      operationId: CorsPreflightInventarioLote
      summary: CORS preflight
      security: []
      x-google-backend:
        address: "${MS_INVENTARIO_URL}"
        path_translation: "APPEND_PATH_TO_ADDRESS"
        disable_auth: true
      responses:
        204: { description: No Content }

  /v1/inventario/entrada:
    post:
      operationId: registro_entrada
      x-google-backend:
        address: "${MS_INVENTARIO_URL}"
        path_translation: "APPEND_PATH_TO_ADDRESS"
        disable_auth: true
      summary: Registrar entrada
      parameters:
        - $ref: "#/parameters/CountryHeader"
        - name: body
          in: body
          required: true
          schema:
            type: object
            required: [lote_id, ubicacion_id, cantidad]
            properties:
              lote_id: { type: string, format: uuid }
              ubicacion_id: { type: string, format: uuid }
              cantidad: { type: integer, format: int32 }
              estado: { type: string }
      responses:
        200: { description: OK }

    options:
      operationId: CorsPreflightInventarioEntrada
      summary: CORS preflight
      security: []
      x-google-backend:
        address: "${MS_INVENTARIO_URL}"
        path_translation: "APPEND_PATH_TO_ADDRESS"
        disable_auth: true
      responses:
        204: { description: No Content }

  /v1/inventario/salida/fefo:
    post:
      operationId: registro_salida
      x-google-backend:
        address: "${MS_INVENTARIO_URL}"
        path_translation: "APPEND_PATH_TO_ADDRESS"
        disable_auth: true
      summary: Salida FEFO
      parameters:
        - $ref: "#/parameters/CountryHeader"
        - name: producto_id
          in: query
          required: true
          type: string
          format: uuid
        - name: cantidad
          in: query
          required: true
          type: integer
          format: int32
        - name: ubicacion_id
          in: query
          required: false
          type: string
          format: uuid
      responses:
        200: { description: OK }

    options:
      operationId: CorsPreflightInventarioSalidaFefo
      summary: CORS preflight
      security: []
      x-google-backend:
        address: "${MS_INVENTARIO_URL}"
        path_translation: "APPEND_PATH_TO_ADDRESS"
        disable_auth: true
      responses:
        204: { description: No Content }

  /v1/inventario/stock/{producto_id}:
    get:
      operationId: stock_total_producto
      x-google-backend:
        address: "${MS_INVENTARIO_URL}"
        path_translation: "APPEND_PATH_TO_ADDRESS"
        disable_auth: true
      summary: Stock total por producto
      parameters:
        - $ref: "#/parameters/CountryHeader"
        - $ref: "#/parameters/ProductoIdParam"
      responses:
        200: { description: OK }

    options:
      operationId: CorsPreflightInventarioStock
      summary: CORS preflight
      security: []
      parameters:
        - $ref: "#/parameters/ProductoIdParam"
      x-google-backend:
        address: "${MS_INVENTARIO_URL}"
        path_translation: "APPEND_PATH_TO_ADDRESS"
        disable_auth: true
      responses:
        204: { description: No Content }

  /v1/inventario/stock/{producto_id}/detalle:
    get:
      operationId: detalle_stock_producto
      x-google-backend:
        address: "${MS_INVENTARIO_URL}"
        path_translation: "APPEND_PATH_TO_ADDRESS"
        disable_auth: true
      summary: Detalle de stock por producto
      parameters:
        - $ref: "#/parameters/CountryHeader"
        - $ref: "#/parameters/ProductoIdParam"
      responses:
        200: { description: OK }

    options:
      operationId: CorsPreflightInventarioStockDetalle
      summary: CORS preflight
      security: []
      parameters:
        - $ref: "#/parameters/ProductoIdParam"
      x-google-backend:
        address: "${MS_INVENTARIO_URL}"
        path_translation: "APPEND_PATH_TO_ADDRESS"
        disable_auth: true
      responses:
        204: { description: No Content }

  /v1/inventario/producto/{producto_id}/detalle:
    get:
      operationId: detalle_producto
      x-google-backend:
        address: "${MS_INVENTARIO_URL}"
        path_translation: "APPEND_PATH_TO_ADDRESS"
        disable_auth: true
      summary: Detalle de producto
      parameters:
        - $ref: "#/parameters/CountryHeader"
        - $ref: "#/parameters/ProductoIdParam"
      responses:
        200: { description: OK }

    options:
      operationId: CorsPreflightInventarioProductoDetalle
      summary: CORS preflight
      security: []
      parameters:
        - $ref: "#/parameters/ProductoIdParam"
      x-google-backend:
        address: "${MS_INVENTARIO_URL}"
        path_translation: "APPEND_PATH_TO_ADDRESS"
        disable_auth: true
      responses:
        204: { description: No Content }

  /v1/inventario/producto/{producto_id}/ubicaciones:
    get:
      operationId: stock_producto_ubicaciones
      x-google-backend:
        address: "${MS_INVENTARIO_URL}"
        path_translation: "APPEND_PATH_TO_ADDRESS"
        disable_auth: true
      summary: Ubicaciones con stock del producto
      parameters:
        - $ref: "#/parameters/CountryHeader"
        - $ref: "#/parameters/ProductoIdParam"
      responses:
        200: { description: OK }

    options:
      operationId: CorsPreflightInventarioProductoUbicaciones
      summary: CORS preflight
      security: []
      parameters:
        - $ref: "#/parameters/ProductoIdParam"
      x-google-backend:
        address: "${MS_INVENTARIO_URL}"
        path_translation: "APPEND_PATH_TO_ADDRESS"
        disable_auth: true
      responses:
        204: { description: No Content }

  /v1/inventario/productos/todos:
    get:
      operationId: productos_todos
      x-google-backend:
        address: "${MS_INVENTARIO_URL}"
        path_translation: "APPEND_PATH_TO_ADDRESS"
        disable_auth: true
      summary: Listar todos los productos (paginado)
      parameters:
        - $ref: "#/parameters/CountryHeader"
        - name: limit
          in: query
          type: integer
          format: int32
          default: 50
        - name: offset
          in: query
          type: integer
          format: int32
          default: 0
      responses:
        200: { description: OK }

    options:
      operationId: CorsPreflightInventarioProductosTodos
      summary: CORS preflight
      security: []
      x-google-backend:
        address: "${MS_INVENTARIO_URL}"
        path_translation: "APPEND_PATH_TO_ADDRESS"
        disable_auth: true
      responses:
        204: { description: No Content }

  /v1/auth/login:
    post:
      operationId: Auth_Login
      security: []   # explícitamente sin auth
      x-google-backend:
        address: "${MS_USUARIOS_AUTENTICACION_URL}"
        path_translation: "APPEND_PATH_TO_ADDRESS"
        disable_auth: true
      summary: Login (emite JWT)
      parameters:
        - $ref: "#/parameters/CountryHeader"
        - name: body
          in: body
          required: true
          schema:
            type: object
            required: [username, password]
            properties:
              username: { type: string }
              password: { type: string }
      responses:
        200:
          description: OK
          schema:
            type: object
            properties:
              access_token:  { type: string }
              refresh_token: { type: string }
              token_type:    { type: string }
              expires_in:    { type: integer, format: int32 }
        401: { description: Unauthorized, schema: { $ref: "#/definitions/ErrorResponse" } }

    options:
      operationId: CorsPreflightAuthLogin
      summary: CORS preflight
      security: []
      x-google-backend:
        address: "${MS_USUARIOS_AUTENTICACION_URL}"
        path_translation: "APPEND_PATH_TO_ADDRESS"
        disable_auth: true
      responses:
        204: { description: No Content }

  /v1/auth/register:
    post:
      operationId: Auth_Register
      security: []
      x-google-backend:
        address: "${MS_USUARIOS_AUTENTICACION_URL}"
        path_translation: "APPEND_PATH_TO_ADDRESS"
        disable_auth: true
      summary: Register user
      parameters:
        - $ref: "#/parameters/CountryHeader"
        - name: body
          in: body
          required: true
          schema:
            type: object
            required: [username, role, institution_name, password]
            properties:
              username: { type: string }
              role: { type: string }
              institution_name: { type: string }
              password: { type: string }
      responses:
        201: { description: Created }
        400: { description: Bad request, schema: { $ref: "#/definitions/ErrorResponse" } }

    options:
      operationId: CorsPreflightAuthRegister
      summary: CORS preflight
      security: []
      x-google-backend:
        address: "${MS_USUARIOS_AUTENTICACION_URL}"
        path_translation: "APPEND_PATH_TO_ADDRESS"
        disable_auth: true
      responses:
        204: { description: No Content }

  /v1/auth/refresh:
    post:
      operationId: Auth_Refresh
      security: []
      x-google-backend:
        address: "${MS_USUARIOS_AUTENTICACION_URL}"
        path_translation: "APPEND_PATH_TO_ADDRESS"
        disable_auth: true
      summary: Refresh token
      parameters:
        - $ref: "#/parameters/CountryHeader"
        - name: body
          in: body
          required: true
          schema:
            type: object
            required: [refresh_token]
            properties:
              refresh_token: { type: string }
      responses:
        200:
          description: OK
          schema:
            type: object
            properties:
              access_token:  { type: string }
              token_type:    { type: string }
              expires_in:    { type: integer, format: int32 }
        401: { description: Unauthorized, schema: { $ref: "#/definitions/ErrorResponse" } }

    options:
      operationId: CorsPreflightAuthRefresh
      summary: CORS preflight
      security: []
      x-google-backend:
        address: "${MS_USUARIOS_AUTENTICACION_URL}"
        path_translation: "APPEND_PATH_TO_ADDRESS"
        disable_auth: true
      responses:
        204: { description: No Content }

  /v1/usuarios/me:
    get:
      operationId: Usuarios_Me
      x-google-backend:
        address: "${MS_USUARIOS_AUTENTICACION_URL}"
        path_translation: "APPEND_PATH_TO_ADDRESS"
        disable_auth: true
      summary: Perfil del usuario autenticado
      parameters:
        - $ref: "#/parameters/CountryHeader"
      responses:
        200: { description: OK, schema: { $ref: "#/definitions/MeResponse" } }
        401: { description: Unauthorized, schema: { $ref: "#/definitions/ErrorResponse" } }

    options:
      operationId: CorsPreflightUsuariosMe
      summary: CORS preflight
      security: []
      x-google-backend:
        address: "${MS_USUARIOS_AUTENTICACION_URL}"
        path_translation: "APPEND_PATH_TO_ADDRESS"
        disable_auth: true
      responses:
        204: { description: No Content }
