swagger: "2.0"
info:
  title: MediSupply API
  version: "1.0.0"

# Opcional: si usas dominio propio gestionado por el gateway
host: ${API_DOMAIN}
basePath: /
schemes: ["https"]
consumes: ["application/json"]
produces: ["application/json"]

# ===== Seguridad (JWT) =====
securityDefinitions:
  jwt_auth:
    type: oauth2
    flow: implicit
    authorizationUrl: ""
    x-google-issuer: "${JWT_ISSUER}"
    x-google-jwks_uri: "${JWT_JWKS_URI}"
    x-google-audiences: "${JWT_AUDIENCE}"

# Por defecto TODO requiere JWT:
security:
  - jwt_auth: []

# ===== Definiciones simples =====
definitions:
  ErrorResponse:
    type: object
    properties:
      message: { type: string }
      code:    { type: integer, format: int32 }

  PedidoCreate:
    type: object
    required: [cliente_id, items]
    properties:
      cliente_id: { type: string }
      items:
        type: array
        items:
          type: object
          required: [sku, qty]
          properties:
            sku: { type: string }
            qty: { type: integer, format: int32 }

  Pedido:
    type: object
    properties:
      id: { type: string }
      status: { type: string }
      created_at: { type: string, format: date-time }

  MeResponse:
    type: object
    properties:
      sub:   { type: string }
      email: { type: string }
      name:  { type: string }
      roles:
        type: array
        items: { type: string }

# ===== Paths =====
paths:
  "/.well-known/jwks.json":
    get:
      operationId: jwksGet
      security: []
      x-google-backend:
        address: "${MS_USUARIOS_AUTENTICACION_URL}"
      summary: JWKS
      responses:
        200: { description: OK }

  /v1/auth/login:
    post:
      operationId: authLogin
      security: []
      x-google-backend:
        address: "${MS_USUARIOS_AUTENTICACION_URL}"
      summary: Login (emite JWT)
      parameters:
        - name: body
          in: body
          required: true
          schema:
            type: object
            required: [username, password]
            properties:
              username: { type: string }
              password: { type: string }
      responses:
        200: { description: OK }

  /v1/auth/refresh:
    post:
      operationId: authRefresh
      security: []
      x-google-backend:
        address: "${MS_USUARIOS_AUTENTICACION_URL}"
      summary: Refresh token
      parameters:
        - name: body
          in: body
          required: true
          schema:
            type: object
            required: [refresh_token]
            properties:
              refresh_token: { type: string }
      responses:
        200: { description: OK }

  /v1/usuarios/me:
    get:
      operationId: usuariosMeGet
      x-google-backend:
        address: "${MS_USUARIOS_AUTENTICACION_URL}"
      summary: Perfil del usuario autenticado
      responses:
        200: { description: OK }

  /{country}/v1/pedidos:
    options:
      operationId: pedidosCors
      security: []
      x-google-backend:
        address: "${MS_PEDIDOS_URL}"
      summary: CORS preflight
      parameters:
        - name: country
          in: path
          required: true
          type: string
      responses:
        204:
          description: No Content
          headers:
            Access-Control-Allow-Origin:  { type: string }
            Access-Control-Allow-Methods: { type: string }
            Access-Control-Allow-Headers: { type: string }

    get:
      operationId: pedidosList
      x-google-backend:
        address: "${MS_PEDIDOS_URL}"
      summary: Listar pedidos (protegido)
      parameters:
        - name: country
          in: path
          required: true
          type: string
      responses:
        200: { description: OK }

    post:
      operationId: pedidosCreate
      x-google-backend:
        address: "${MS_PEDIDOS_URL}"
      summary: Crear pedido (protegido)
      parameters:
        - name: country
          in: path
          required: true
          type: string
        - name: body
          in: body
          required: true
          schema:
            $ref: "#/definitions/PedidoCreate"
      responses:
        201: { description: Creado }
